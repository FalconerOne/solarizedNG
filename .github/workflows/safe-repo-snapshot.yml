name: Repo Snapshots (Auto + Manual + Nightly + Log)

on:
  push:
    branches:
      - main
      - production

  workflow_dispatch:
    inputs:
      label:
        description: 'Optional label or reason for manual snapshot (e.g. before update)'
        required: false
        default: 'manual'

  schedule:
    # Runs every night at 23:30 UTC
    - cron: "30 23 * * *"

jobs:
  snapshot:
    runs-on: ubuntu-latest
    name: Create Snapshot (Auto/Manual/Nightly)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Needed for tagging and commits

      - name: Generate timestamp
        id: time
        run: echo "timestamp=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Determine snapshot type
        id: type
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "type=nightly" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "type=manual" >> $GITHUB_OUTPUT
          else
            echo "type=auto" >> $GITHUB_OUTPUT
          fi

      - name: Compute label
        id: label
        run: |
          INPUT_LABEL="${{ github.event.inputs.label }}"
          if [[ -z "$INPUT_LABEL" ]]; then
            LABEL="${{ steps.type.outputs.type }}"
          else
            LABEL="$INPUT_LABEL"
          fi
          SAFE_LABEL=$(echo "$LABEL" | tr -cd '[:alnum:]_-')
          echo "safe_label=$SAFE_LABEL" >> $GITHUB_OUTPUT

      - name: Prepare branch and tag names
        id: names
        run: |
          SNAP_TYPE="${{ steps.type.outputs.type }}"
          LABEL="${{ steps.label.outputs.safe_label }}"
          TS="${{ steps.time.outputs.timestamp }}"
          BRANCH_NAME="${SNAP_TYPE}-snapshot-${LABEL}-${TS}"
          TAG_NAME="${SNAP_TYPE}-snapshot-${LABEL}-${TS}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Create snapshot branch
        run: |
          git checkout -b "${{ steps.names.outputs.branch_name }}"
          git push origin "${{ steps.names.outputs.branch_name }}" || echo "‚ö†Ô∏è Branch push skipped (already exists)"

      - name: Create snapshot tag
        run: |
          git tag -a "${{ steps.names.outputs.tag_name }}" -m "Snapshot created: ${{ steps.names.outputs.tag_name }}"
          git push origin "${{ steps.names.outputs.tag_name }}" || echo "‚ö†Ô∏è Tag push skipped (already exists)"

      - name: Confirm snapshot creation
        run: echo "üéâ Snapshot (${{ steps.type.outputs.type }}) created successfully"

      - name: Update snapshot log
        env:
          SNAP_TYPE: ${{ steps.type.outputs.type }}
          TAG_NAME: ${{ steps.names.outputs.tag_name }}
          GH_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          GIT_AUTHOR_NAME: ${{ github.actor }}
        run: |
          LOG_FILE="snapshot-log.md"
          DATE_STR=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          ENTRY="| $DATE_STR | $SNAP_TYPE | $TAG_NAME | [$GIT_AUTHOR_NAME]($GH_RUN_URL) |"
          echo "$ENTRY" >> "$LOG_FILE"

          if ! grep -q "### Snapshot Log" "$LOG_FILE"; then
            echo "### Snapshot Log" > temp && cat "$LOG_FILE" >> temp && mv temp "$LOG_FILE"
            echo "" >> "$LOG_FILE"
            echo "| Date | Type | Tag | Triggered By |" >> "$LOG_FILE"
            echo "|------|------|-----|--------------|" >> "$LOG_FILE"
          fi

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add "$LOG_FILE"
          git commit -m "üóìÔ∏è Log snapshot: $TAG_NAME" || echo "No log update needed"
          git push origin main || echo "‚ö†Ô∏è Could not push log (main branch lock or protection)"

      - name: Cleanup old nightly snapshots (keep last 20)
        if: ${{ steps.type.outputs.type == 'nightly' }}
        run: |
          echo "üßπ Cleaning older nightly tags..."
          git fetch --tags
          TAGS=$(git tag -l "nightly-snapshot-*" | sort -r | tail -n +21)
          for TAG in $TAGS; do
            echo "Deleting old tag: $TAG"
            git push origin :refs/tags/$TAG || true
          done
