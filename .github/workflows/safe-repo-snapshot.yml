name: Repo Snapshots (Auto + Manual + Nightly + Meta Log)

on:
  push:
    branches:
      - main
      - production

  workflow_dispatch:
    inputs:
      label:
        description: "Optional label or reason for manual snapshot (e.g., before major update)"
        required: false
        default: "manual"

  schedule:
    # Runs every night at 23:30 UTC
    - cron: "30 23 * * *"

jobs:
  snapshot:
    runs-on: ubuntu-latest
    name: Create Repository Snapshot (Full Safe Version)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup timestamp
        id: time
        run: echo "timestamp=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

      - name: Determine snapshot type
        id: type
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "type=nightly" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "type=manual" >> $GITHUB_OUTPUT
          else
            echo "type=auto" >> $GITHUB_OUTPUT
          fi

      - name: Compute safe label
        id: label
        run: |
          INPUT_LABEL="${{ github.event.inputs.label }}"
          if [[ -z "$INPUT_LABEL" ]]; then
            LABEL="${{ steps.type.outputs.type }}"
          else
            LABEL="$INPUT_LABEL"
          fi
          SAFE_LABEL=$(echo "$LABEL" | tr -cd '[:alnum:]_-')
          echo "safe_label=$SAFE_LABEL" >> $GITHUB_OUTPUT

      - name: Prepare branch and tag names
        id: names
        run: |
          TYPE="${{ steps.type.outputs.type }}"
          LABEL="${{ steps.label.outputs.safe_label }}"
          TS="${{ steps.time.outputs.timestamp }}"
          BRANCH_NAME="${TYPE}-snapshot-${LABEL}-${TS}"
          TAG_NAME="${TYPE}-snapshot-${LABEL}-${TS}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Generate metadata
        run: |
          mkdir -p .github/snapshots
          cat <<EOF > .github/snapshots/repo-meta.json
          {
            "snapshot": "${{ steps.names.outputs.tag_name }}",
            "timestamp": "${{ steps.time.outputs.timestamp }}",
            "event": "${{ github.event_name }}",
            "initiator": "${{ github.actor }}",
            "branch": "${{ github.ref_name }}",
            "repository": "${{ github.repository }}",
            "commit": "${{ github.sha }}",
            "url": "${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
          }
          EOF

      - name: Commit metadata file
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .github/snapshots/repo-meta.json
          git commit -m "üóÇÔ∏è Add repo snapshot metadata [${{ steps.names.outputs.tag_name }}]" || echo "No changes to commit"

      - name: Push metadata update
        run: git push origin main || echo "‚ö†Ô∏è Push skipped (branch protection may block direct commits)"

      - name: Create snapshot branch
        run: |
          git checkout -b "${{ steps.names.outputs.branch_name }}"
          git push origin "${{ steps.names.outputs.branch_name }}" || echo "‚ö†Ô∏è Branch push skipped (already exists)"

      - name: Create snapshot tag
        run: |
          git tag -a "${{ steps.names.outputs.tag_name }}" -m "Snapshot created: ${{ steps.names.outputs.tag_name }}"
          git push origin "${{ steps.names.outputs.tag_name }}" || echo "‚ö†Ô∏è Tag push skipped (already exists)"

      - name: Confirm snapshot creation
        run: echo "üéâ Snapshot ${{ steps.names.outputs.tag_name }} created successfully"

      - name: Cleanup old snapshot branches (keep 10 latest)
        run: |
          SNAPSHOTS=$(git branch -r | grep snapshot | sort -r | tail -n +11)
          if [ -n "$SNAPSHOTS" ]; then
            echo "$SNAPSHOTS" | sed 's/origin\///' | while read branch; do
              git push origin --delete "$branch" || true
            done
          else
            echo "No old snapshot branches to delete."
          fi
